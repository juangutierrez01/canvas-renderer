<!DOCTYPE html>
<html>
  <head>
    <title>renderer</title>
  </head>
  <body style="margin:0;overflow:hidden">
    <canvas style="display:block"></canvas>
    <script>
/****************************************************************************/
const canvas = document.querySelector("canvas");
const context = canvas.getContext("2d");

const points = [
  [-1, -1, -1],
  [-1, 1, -1],
  [1, 1, -1],
  [1, -1, -1],
  [-1, -1, 1],
  [-1, 1, 1],
  [1, 1, 1],
  [1, -1, 1],
  [3, -1, -1],
  [3, 1, -1],
  [5, 1, -1],
  [5, -1, -1],
  [3, -1, 1],
  [3, 1, 1],
  [5, 1, 1],
  [5, -1, 1],
  [-5, -1, -1],
  [-5, 1, -1],
  [-3, 1, -1],
  [-3, -1, -1],
  [-5, -1, 1],
  [-5, 1, 1],
  [-3, 1, 1],
  [-3, -1, 1]
];

const camera = {
  position: [0, -5, 0],
  direction: [0, 1, 0],
  up: [0, 0, 1],
  right: [1, 0, 0],
  fieldOfView: 5 * Math.PI / 9,
  calculateScreenPosition: function(point) {
    const d = this.direction;
    const up = this.up;
    const ri = this.right;
    const fov = this.fieldOfView;
    const v = [
      point[0] - this.position[0],
      point[1] - this.position[1],
      point[2] - this.position[2]
    ];

    const dotProduct = d[0]*v[0] + d[1]*v[1] + d[2]*v[2];
    const projection = [
      v[0] - d[0]*dotProduct,
      v[1] - d[1]*dotProduct,
      v[2] - d[2]*dotProduct,
    ];

    const visualAngle = Math.acos(dotProduct / Math.hypot(v[0], v[1], v[2])) * 2;
    const canvasRadius = Math.max(canvas.width, canvas.height) / 2;

    const p = projection;
    const hypot = Math.hypot(p[0], p[1], p[2]) || 1;
    return [
      (canvas.width / 2) + (visualAngle / fov) * canvasRadius * (p[0]*ri[0] + p[1]*ri[1] + p[2]*ri[2]) / hypot,
      (canvas.height / 2) + (visualAngle / fov) * canvasRadius * (p[0]*up[0] + p[1]*up[1] + p[2]*up[2]) / hypot
    ]
  }
};

let horizontal = 0;
let vertical = 0;

window.addEventListener("resize", (function resizeCanvas() {
    canvas.width = document.documentElement.clientWidth;
    canvas.height = document.documentElement.clientHeight;
    return resizeCanvas;
})());

window.addEventListener("keydown", (event) => {
  switch (event.code) {
    case "KeyW":
      vertical = 1;
      break;
    case "KeyA":
      horizontal = -1;
      break;
    case "KeyS":
      vertical = -1;
      break;
    case "KeyD":
      horizontal = 1;
      break;
    default:
      break;
  }
});

window.addEventListener("keyup", (event) => {
  switch (event.code) {
    case "KeyW":
      vertical = 0;
      break;
    case "KeyA":
      horizontal = 0;
      break;
    case "KeyS":
      vertical = 0;
      break;
    case "KeyD":
      horizontal = 0;
      break;
    default:
      break;
  }
});

window.addEventListener("blur", (event) => {
  horizontal = 0;
  vertical = 0;
});

window.requestAnimationFrame(function draw() {
  window.requestAnimationFrame(draw);

  camera.position[0] += horizontal * 0.03;
  camera.position[1] += vertical * 0.03;
  
  context.fillStyle = "white";
  context.fillRect(0, 0, canvas.width, canvas.height);

  context.fillStyle = "black";
  for (const point of points) {
    const [x, y] = camera.calculateScreenPosition(point);
    context.fillRect(x - 5, y - 5, 10, 10);
  }
});
/****************************************************************************/
    </script>
  </body>
</html>
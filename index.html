<!DOCTYPE html>
<html>
  <head>
    <title>renderer</title>
  </head>
  <body style="margin:0;overflow:hidden">
    <canvas style="display:block"></canvas>
    <script>
/****************************************************************************/
const canvas = document.querySelector("canvas");
const context = canvas.getContext("2d");

const V = {
  magnitude: function(v) {
    return Math.hypot(v[0], v[1], v[2]);
  },

  dot: function(v1, v2) {
    return v1[0]*v2[0] + v1[1]*v2[1] + v1[2]*v2[2];
  },

  angle: function(v1, v2) {
    return Math.acos(this.dot(v1, v2) / (this.magnitude(v1) * this.magnitude(v2)))
  },

  difference: function(v1, v2) {
    return [v1[0] - v2[0], v1[1] - v2[1], v1[2] - v2[2]];
  },

  scaled: function(v, s) {
    return [s*v[0], s*v[1], s*v[2]];
  },

  unit: function(v) {
    return this.scaled(v, 1 / this.magnitude(v));
  },

  projection: function(v1, v2) {
    return this.scaled(v2, this.dot(v1, v2) / Math.pow(this.magnitude(v2), 2));
  }
}

const points = [
  [-1, -1, -1],
  [-1, 1, -1],
  [1, 1, -1],
  [1, -1, -1],
  [-1, -1, 1],
  [-1, 1, 1],
  [1, 1, 1],
  [1, -1, 1],
  [3, -1, -1],
  [3, 1, -1],
  [5, 1, -1],
  [5, -1, -1],
  [3, -1, 1],
  [3, 1, 1],
  [5, 1, 1],
  [5, -1, 1],
  [-5, -1, -1],
  [-5, 1, -1],
  [-3, 1, -1],
  [-3, -1, -1],
  [-5, -1, 1],
  [-5, 1, 1],
  [-3, 1, 1],
  [-3, -1, 1]
];

const camera = {
  position: [0, -5, 0],
  direction: [0, 1, 0],
  up: [0, 0, 1],
  right: [1, 0, 0],
  fieldOfView: 5 * Math.PI / 9,
  screenPosition: function(point) {
    const d = this.direction;
    const up = this.up;
    const ri = this.right;
    const fov = this.fieldOfView;
    const v = V.difference(point, this.position); 

    const dotProduct = V.dot(d, v);
    const projection = V.difference(v, V.projection(v, d));
    const visualAngle = V.angle(d, v) * 2;
    const canvasRadius = Math.max(canvas.width, canvas.height) / 2;

    const p = projection;
    const hypot = V.magnitude(p) || 1;

    const x = (visualAngle / fov) * canvasRadius * V.dot(p, ri) / hypot;
    const y = (visualAngle / fov) * canvasRadius * V.dot(p, up) / hypot;
    return [
      (canvas.width / 2) + x,
      (canvas.height / 2) + y 
    ]
  }
};

let horizontal = 0;
let vertical = 0;

window.addEventListener("resize", (function resizeCanvas() {
    canvas.width = document.documentElement.clientWidth;
    canvas.height = document.documentElement.clientHeight;
    return resizeCanvas;
})());

window.addEventListener("keydown", (event) => {
  switch (event.code) {
    case "KeyW":
      vertical = 1;
      break;
    case "KeyA":
      horizontal = -1;
      break;
    case "KeyS":
      vertical = -1;
      break;
    case "KeyD":
      horizontal = 1;
      break;
    default:
      break;
  }
});

window.addEventListener("keyup", (event) => {
  switch (event.code) {
    case "KeyW":
      vertical = 0;
      break;
    case "KeyA":
      horizontal = 0;
      break;
    case "KeyS":
      vertical = 0;
      break;
    case "KeyD":
      horizontal = 0;
      break;
    default:
      break;
  }
});

window.addEventListener("blur", (event) => {
  horizontal = 0;
  vertical = 0;
});

window.requestAnimationFrame(function draw() {
  window.requestAnimationFrame(draw);

  camera.position[0] += horizontal * 0.03;
  camera.position[1] += vertical * 0.03;
  
  context.fillStyle = "white";
  context.fillRect(0, 0, canvas.width, canvas.height);

  context.fillStyle = "black";
  for (const point of points) {
    const [x, y] = camera.screenPosition(point);
    context.fillRect(x - 5, y - 5, 10, 10);
  }
});
/****************************************************************************/
    </script>
  </body>
</html>
